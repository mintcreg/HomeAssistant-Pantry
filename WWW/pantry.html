<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantry Manager</title>
    <style>
        /* Your existing styles */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 100%;
            width: 90%;
            margin: 40px auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .category-buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .category-buttons button {
            padding: 12px 20px;
            font-size: 16px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .category-buttons button:hover {
            background-color: #0056b3;
        }
        .category-header {
            font-weight: bold;
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .category-content {
            display: block;
            margin-bottom: 20px;
        }
        .product-image {
            max-width: 50px;
            max-height: 50px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        table, th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .add-remove-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .add-remove-buttons button {
            padding: 10px 20px;
            font-size: 14px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .add-remove-buttons .add-btn {
            background-color: #28a745;
            color: white;
        }
        .add-remove-buttons .add-btn:hover {
            background-color: #218838;
        }
        .add-remove-buttons .remove-btn {
            background-color: #dc3545;
            color: white;
        }
        .add-remove-buttons .remove-btn:hover {
            background-color: #c82333;
        }
        .hidden {
            display: none;
        }
        #config-container {
            display: none;
        }
        #product-rows, #edit-product-rows {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #product-rows .config-row, #edit-product-rows .config-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
        }
        #product-rows input, #product-rows select, #edit-product-rows input, #edit-product-rows select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            box-sizing: border-box;
        }
        .add-row-btn, .generate-btn, .clear-btn {
            width: 100%;
            max-width: 100%;
            background-color: #28a745;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            text-align: center;
            margin: 10px 0;
        }
        .generate-btn {
            background-color: #007bff;
        }
        .clear-btn {
            background-color: #dc3545;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-top: 20px;
        }
        .yaml-output {
            margin-top: 20px;
            display: none;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .category-buttons button {
                width: 100%;
                margin: 10px 0;
            }
            table, th, td {
                font-size: 14px;
            }
            .add-remove-buttons button {
                font-size: 12px;
                padding: 8px 10px;
            }
            .product-image {
                max-width: 40px;
                max-height: 40px;
            }
            #product-rows .config-row, #edit-product-rows .config-row {
                flex-direction: column;
            }
            .add-row-btn, .generate-btn, .clear-btn {
                padding: 15px;
            }
        }
    </style>
</head>
<body onload="showTab('home')">

<div class="container">
    <h1>Pantry Manager</h1>

    <div class="category-buttons">
        <button onclick="showTab('home')">Home</button>
        <button onclick="showTab('generate')">Generate</button>
        <button onclick="showTab('edit')">Edit</button>
    </div>

    <!-- Home Tab -->
    <div id="home-container" class="tab-content">
        <div id="categories-container"></div> <!-- Categories will be rendered here -->
    </div>

    <!-- Generate Tab -->
    <div id="generate-container" class="tab-content hidden">
        <h2>Generate Products YAML</h2>

        <div id="product-rows">
            <div class="config-row">
                <input type="text" placeholder="Product Name" class="product-name" />
                <input type="text" placeholder="Image URL" />
                <select class="category-select">
                    <option value="">Select Category</option>
                </select>
                <label>
                    <input type="checkbox" class="category-checkbox" onchange="updateCategories()"> Mark as Category
                </label>
            </div>
        </div>

        <button class="add-row-btn" onclick="addRow()">Add Row</button>
        <button class="generate-btn" onclick="generateYAML()">Generate YAML</button>
        <button class="clear-btn" onclick="clearForm()">Clear Form</button>

        <div id="yaml-output" class="yaml-output">
            <h3>Generated Input Number YAML</h3>
            <textarea id="input-number-yaml-output" readonly></textarea>

            <h3>Generated Customize YAML</h3>
            <textarea id="customize-yaml-output" readonly></textarea>
        </div>
    </div>

    <!-- Edit Tab -->
    <div id="edit-container" class="tab-content hidden">
        <h2>Edit Existing YAML</h2>

        <!-- Dropdown for Existing YAML -->
        <button class="dropdown-btn" onclick="toggleDropdown()">Existing YAML</button>
        <div class="dropdown-container">
            <h3>Upload Input Number YAML</h3>
            <textarea id="input-number-yaml-output-edit" placeholder="Paste input_number YAML here to edit"></textarea>

            <h3>Upload Customize YAML</h3>
            <textarea id="customize-yaml-output-edit" placeholder="Paste customize YAML here to edit"></textarea>

            <button class="generate-btn" onclick="parseYAML()">Load YAML into Form</button>
        </div>

        <div id="edit-product-rows"></div>

        <button class="add-row-btn" onclick="addRowToEdit()">Add Row</button>
        <button class="generate-btn" onclick="generateEditedYAML()">Generate New YAML</button>
        <button class="clear-btn" onclick="clearForm()">Clear Form</button>

        <div id="yaml-output-edit" class="yaml-output">
            <h3>Generated Input Number YAML</h3>
            <textarea id="input-number-yaml-output-edit-result" readonly></textarea>

            <h3>Generated Customize YAML</h3>
            <textarea id="customize-yaml-output-edit-result" readonly></textarea>
        </div>
    </div>
</div>

<script>
    let categories = []; // Global categories array

    // Toggles the Existing YAML dropdown
    function toggleDropdown() {
        const dropdownContainer = document.querySelector('.dropdown-container');
        dropdownContainer.style.display = dropdownContainer.style.display === 'block' ? 'none' : 'block';
    }

    const homeAssistantToken = 'LONGLIVEACCESSTOKEN';  // Replace with your Home Assistant token
    const baseUrl = 'https://yourexternalurl.com';  // Replace with your Home Assistant URL

    const fetchProducts = async () => {
        try {
            const response = await fetch(`${baseUrl}/api/states`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${homeAssistantToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch products: ${response.statusText}`);
            }

            const entities = await response.json();
            const stockEntities = entities.filter(entity => {
                return entity.entity_id.startsWith('input_number.stock_') && entity.attributes.min !== -10;
            });

            if (stockEntities.length > 0) {
                displayProducts(stockEntities);
            } else {
                console.error('No stock entities found');
            }
        } catch (error) {
            console.error('Error fetching products:', error);
        }
    };

    const displayProducts = (products) => {
        const categoriesContainer = document.getElementById('categories-container');
        categoriesContainer.innerHTML = ''; // Clear existing content

        const categories = {};
        let uncategorized = [];

        products.forEach(product => {
            const productName = formatProductName(product.entity_id);
            const productImage = product.attributes.product_image || 'default-image.jpg'; // Provide a default image if missing
            const productCategory = product.attributes.assoc_cat || null;

            if (productCategory) {
                if (!categories[productCategory]) {
                    categories[productCategory] = [];
                }
                categories[productCategory].push({
                    productName,
                    productImage,
                    entityId: product.entity_id,
                    quantity: product.state
                });
            } else {
                uncategorized.push({
                    productName,
                    productImage,
                    entityId: product.entity_id,
                    quantity: product.state
                });
            }
        });

        Object.keys(categories).forEach(category => {
            const categoryHeader = document.createElement('div');
            categoryHeader.classList.add('category-header');
            categoryHeader.innerHTML = capitalizeFirstLetter(category);
            categoryHeader.onclick = () => toggleCategory(category);

            const categoryContent = document.createElement('div');
            categoryContent.classList.add('category-content');
            categoryContent.id = `category-${category}`;

            const table = document.createElement('table');
            const tableHead = `
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Product Image</th>
                        <th>Quantity Remaining</th>
                        <th>Add/Remove</th>
                    </tr>
                </thead>
            `;
            const tableBody = document.createElement('tbody');
            categories[category].forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.productName}</td>
                    <td><img src="${product.productImage}" alt="${product.productName}" class="product-image" /></td>
                    <td id="quantity-${product.entityId}">${parseInt(product.quantity)}</td>
                    <td class="add-remove-buttons">
                        <button class="remove-btn" onclick="adjustQuantity('${product.entityId}', -1)">-</button>
                        <button class="add-btn" onclick="adjustQuantity('${product.entityId}', 1)">+</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            table.innerHTML = tableHead;
            table.appendChild(tableBody);
            categoryContent.appendChild(table);

            categoriesContainer.appendChild(categoryHeader);
            categoriesContainer.appendChild(categoryContent);
        });

        // Only display the "Uncategorized" section if there are items without a category
        if (uncategorized.length > 0) {
            const uncategorizedHeader = document.createElement('div');
            uncategorizedHeader.classList.add('category-header');
            uncategorizedHeader.innerHTML = 'Uncategorized';
            uncategorizedHeader.onclick = () => toggleCategory('uncategorized');

            const uncategorizedContent = document.createElement('div');
            uncategorizedContent.classList.add('category-content');
            uncategorizedContent.id = 'category-uncategorized';

            const table = document.createElement('table');
            const tableHead = `
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Product Image</th>
                        <th>Quantity Remaining</th>
                        <th>Add/Remove</th>
                    </tr>
                </thead>
            `;
            const tableBody = document.createElement('tbody');
            uncategorized.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.productName}</td>
                    <td><img src="${product.productImage}" alt="${product.productName}" class="product-image" /></td>
                    <td id="quantity-${product.entityId}">${parseInt(product.quantity)}</td>
                    <td class="add-remove-buttons">
                        <button class="remove-btn" onclick="adjustQuantity('${product.entityId}', -1)">-</button>
                        <button class="add-btn" onclick="adjustQuantity('${product.entityId}', 1)">+</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            table.innerHTML = tableHead;
            table.appendChild(tableBody);
            uncategorizedContent.appendChild(table);

            categoriesContainer.appendChild(uncategorizedHeader);
            categoriesContainer.appendChild(uncategorizedContent);
        }
    };

    const adjustQuantity = async (entityId, adjustment) => {
        const currentQuantity = parseInt(document.getElementById(`quantity-${entityId}`).textContent);
        const newQuantity = currentQuantity + adjustment;

        if (newQuantity >= 0) {
            await fetch(`${baseUrl}/api/services/input_number/set_value`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${homeAssistantToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ entity_id: entityId, value: newQuantity })
            });

            document.getElementById(`quantity-${entityId}`).textContent = newQuantity;
        }
    };

    const formatProductName = (entityId) => {
        const namePart = entityId.replace('input_number.stock_', '');
        const nameComponents = namePart.split('_').slice(1);
        const productName = nameComponents.map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        return productName;
    };

    const capitalizeFirstLetter = (string) => {
        return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
    };

    const toggleCategory = (category) => {
        const categoryContent = document.getElementById(`category-${category}`);
        categoryContent.style.display = categoryContent.style.display === 'none' ? 'block' : 'none';
    };

    function showTab(tab) {
        document.getElementById('home-container').style.display = tab === 'home' ? 'block' : 'none';
        document.getElementById('generate-container').style.display = tab === 'generate' ? 'block' : 'none';
        document.getElementById('edit-container').style.display = tab === 'edit' ? 'block' : 'none';

        if (tab === 'home') {
            fetchProducts();
        }
    }

    // Function to update dropdowns with current categories
    function updateCategoryDropdowns() {
        const dropdowns = document.querySelectorAll('.category-select');
        dropdowns.forEach(dropdown => {
            dropdown.innerHTML = `<option value="">Select Category</option>`; // Reset dropdown
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                dropdown.appendChild(option);
            });
        });
    }

    // Add row to the "Generate" page
    function addRow() {
        const productRows = document.getElementById('product-rows');
        const newRow = document.createElement('div');
        newRow.classList.add('config-row');
        newRow.innerHTML = `
            <input type="text" placeholder="Product Name" class="product-name" />
            <input type="text" placeholder="Image URL" />
            <select class="category-select">
                <option value="">Select Category</option>
            </select>
            <label>
                <input type="checkbox" class="category-checkbox" onchange="updateCategories()"> Mark as Category
            </label>
        `;
        productRows.appendChild(newRow);
        updateCategoryDropdowns(); // Update dropdown list after adding new row
    }

    // Function to update categories when a row is marked as a category
    function updateCategories() {
        const rows = document.querySelectorAll('#product-rows .config-row, #edit-product-rows .config-row');
        categories = []; // Clear the categories array and repopulate it

        rows.forEach(row => {
            const productName = row.querySelector('.product-name').value.trim().toLowerCase().replace(/\s+/g, '_');
            const isCategory = row.querySelector('.category-checkbox').checked;
            if (isCategory && productName) {
                categories.push(productName); // Add to categories list if marked as a category
            }
        });

        updateCategoryDropdowns(); // Refresh dropdowns after updating categories
    }

    // Generate YAML based on inputs on the "Generate" page
    function generateYAML() {
        const rows = document.querySelectorAll('#product-rows .config-row');
        let inputNumberYAML = '';
        let customizeYAML = '';

        rows.forEach(row => {
            const productName = row.querySelector('.product-name').value.trim().toLowerCase().replace(/\s+/g, '_');
            const imageUrl = row.querySelector('input[type="text"]').nextElementSibling.value.trim();
            const isCategory = row.querySelector('.category-checkbox').checked;
            const selectedCategory = row.querySelector('.category-select').value;

            if (isCategory) {
                categories.push(productName); // Add to categories list if marked as a category
                inputNumberYAML += `  stock_pantry_${productName}:\n    name: ${productName.replace(/_/g, ' ')}\n    min: -10\n    max: 0\n    initial: -10\n`;
                customizeYAML += `    input_number.stock_pantry_${productName}:\n      product_category: "${productName.replace(/_/g, ' ')}"\n`;
            } else {
                inputNumberYAML += `  stock_pantry_${productName}:\n    name: ${productName.replace(/_/g, ' ')}\n    min: 0\n    max: 100\n    step: 1\n`;
                customizeYAML += `    input_number.stock_pantry_${productName}:\n      product_image: "${imageUrl}"\n      assoc_cat: "${selectedCategory}"\n`;
            }
        });

        document.getElementById('input-number-yaml-output').value = inputNumberYAML;
        document.getElementById('customize-yaml-output').value = customizeYAML;

        document.getElementById('yaml-output').style.display = 'block';
        updateCategoryDropdowns(); // Update dropdown after generating YAML
    }

    // Clear the form on the "Generate" page
    function clearForm() {
        document.getElementById('product-rows').innerHTML = `
            <div class="config-row">
                <input type="text" placeholder="Product Name" class="product-name" />
                <input type="text" placeholder="Image URL" />
                <select class="category-select">
                    <option value="">Select Category</option>
                </select>
                <label>
                    <input type="checkbox" class="category-checkbox"> Mark as Category
                </label>
            </div>
        `;
        categories = []; // Reset categories when the form is cleared
        document.getElementById('yaml-output').style.display = 'none';
    }

    // Add row to the "Edit" page
    function addRowToEdit() {
        const productRows = document.getElementById('edit-product-rows');
        const newRow = document.createElement('div');
        newRow.classList.add('config-row');
        newRow.innerHTML = `
            <input type="text" placeholder="Product Name" />
            <input type="text" placeholder="Image URL" />
            <select class="category-select">
                <option value="pantry">Pantry</option>
            </select>
            <label>
                <input type="checkbox" class="category-checkbox"> Mark as Category
            </label>
        `;
        productRows.appendChild(newRow);
        updateCategoryDropdowns();
    }

    // Generate Edited YAML on the "Edit" page
    function generateEditedYAML() {
        const rows = document.querySelectorAll('#edit-product-rows .config-row');
        let inputNumberYAML = '';
        let customizeYAML = '';

        rows.forEach(row => {
            const productName = row.querySelector('input[type="text"]').value.trim().toLowerCase().replace(/\s+/g, '_');
            const imageUrl = row.querySelector('input[type="text"]').nextElementSibling.value.trim();
            const isCategory = row.querySelector('.category-checkbox').checked;

            if (isCategory) {
                inputNumberYAML += `  stock_pantry_${productName}:\n    name: ${productName.replace(/_/g, ' ')}\n    min: -10\n    max: -10\n    initial: -10\n`;
                customizeYAML += `    input_number.stock_pantry_${productName}:\n      product_category: "${productName.replace(/_/g, ' ')}"\n`;
            } else {
                inputNumberYAML += `  stock_pantry_${productName}:\n    name: ${productName.replace(/_/g, ' ')}\n    min: 0\n    max: 100\n    step: 1\n`;
                customizeYAML += `    input_number.stock_pantry_${productName}:\n      product_image: "${imageUrl}"\n`;
            }
        });

        document.getElementById('input-number-yaml-output-edit-result').value = inputNumberYAML;
        document.getElementById('customize-yaml-output-edit-result').value = customizeYAML;

        document.getElementById('yaml-output-edit').style.display = 'block';
    }

    // Clear the form on the "Edit" page
    function clearForm() {
        document.getElementById('edit-product-rows').innerHTML = '';
        document.getElementById('yaml-output-edit').style.display = 'none';
    }

    // Parse the uploaded YAML on the "Edit" page
    function parseYAML() {
        const inputYAML = document.getElementById('input-number-yaml-output-edit').value;
        const customizeYAML = document.getElementById('customize-yaml-output-edit').value;
        const productRows = document.getElementById('edit-product-rows');
        productRows.innerHTML = '';

        const inputEntries = inputYAML.trim().split(/\n(?=  stock_pantry_)/);
        inputEntries.forEach(entry => {
            if (entry) {
                const match = entry.match(/  stock_pantry_(.*):\n.*name: (.*)\n/);
                if (match) {
                    const productName = match[2].trim();
                    const imageUrl = (customizeYAML.match(new RegExp(`${match[1]}.*product_image: "(.*)"`)) || [])[1] || '';
                    const isCategory = inputYAML.includes('min: -10');
                    addRowFromYAML(productName, imageUrl, isCategory);
                }
            }
        });
    }

    // Helper function to add rows from parsed YAML
    function addRowFromYAML(productName, imageUrl, isCategory = false) {
        const productRows = document.getElementById('edit-product-rows');
        const newRow = document.createElement('div');
        newRow.classList.add('config-row');
        newRow.innerHTML = `
            <input type="text" value="${productName}" />
            <input type="text" value="${imageUrl}" />
            <select class="category-select">
                <option value="pantry">Pantry</option>
            </select>
            <label>
                <input type="checkbox" class="category-checkbox" ${isCategory ? 'checked' : ''}> Mark as Category
            </label>
        `;
        productRows.appendChild(newRow);
        updateCategoryDropdowns(); // Ensure category dropdowns stay updated in the "Edit" form.
    }
</script>

</body>
</html>
